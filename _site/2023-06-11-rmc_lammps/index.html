<!DOCTYPE html>
<html lang="en">
<!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png">
<link rel="manifest" href="/assets/img/site.webmanifest">
<link rel="mask-icon" href="/assets/img/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>RMCProfile + LAMMPS Implementation</title>

  
  <meta name="author" content="Yuanpeng Zhang">
  

  <meta name="description" content="This blog is a collection of notes about implementing the lammps engine in our RMCProfile package [1] for energy calculation, using the provided wrapper routines provided with the lammps distribution. The note will be covering the installation of MPI compilers, building the lammps wrapper libraries, the implementation in the caller...">

  

  

  <link rel="alternate" type="application/rss+xml" title="Yuanpeng's Blog" href="http://localhost:4000/feed.xml">

  

  

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-44PBCNZ80G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-44PBCNZ80G');
</script>

  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  

  
  
  

  

  
  <meta property="og:site_name" content="Yuanpeng's Blog">
  <meta property="og:title" content="RMCProfile + LAMMPS Implementation">
  <meta property="og:description" content="This blog is a collection of notes about implementing the lammps engine in our RMCProfile package [1] for energy calculation, using the provided wrapper routines provided with the lammps distribution. The note will be covering the installation of MPI compilers, building the lammps wrapper libraries, the implementation in the caller...">

  
  <meta property="og:image" content="http://localhost:4000/assets/img/avatar-icon.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="Yuanpeng Zhang">
  <meta property="og:article:published_time" content="2023-06-11T00:00:00-04:00">
  <meta property="og:url" content="http://localhost:4000/2023-06-11-rmc_lammps/">
  <link rel="canonical" href="http://localhost:4000/2023-06-11-rmc_lammps/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@">
  <meta name="twitter:creator" content="@">

  <meta property="twitter:title" content="RMCProfile + LAMMPS Implementation">
  <meta property="twitter:description" content="This blog is a collection of notes about implementing the lammps engine in our RMCProfile package [1] for energy calculation, using the provided wrapper routines provided with the lammps distribution. The note will be covering the installation of MPI compilers, building the lammps wrapper libraries, the implementation in the caller...">

  
  <meta name="twitter:image" content="http://localhost:4000/assets/img/avatar-icon.png">
  

  


  

  

<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script async='async' src='https://www.gstatic.com/external_hosted/clipboardjs/clipboard.min.js'></script>
<script src='https://unpkg.com/sweetalert@2.1.2/dist/sweetalert.min.js'></script>
<script language='JavaScript'>
  function copytoclipboard(containerid){
    if (document.selection) {
      var range = document.body.createTextRange();
      range.moveToElementText(document.getElementById(containerid));
      range.select().createTextRange();
      document.execCommand("copy");
    } else if (window.getSelection) {
      var range = document.createRange();
      range.selectNode(document.getElementById(containerid));
      var selection = window.getSelection() // get Selection object from currently user selected text
      selection.removeAllRanges() // unselect any user selected text (if any)
      selection.addRange(range) // add range to Selection object to select it
      document.execCommand("copy");
      //alert("Codes snippet copied to clipboard!")
      swal({
      title: "",
      text: "Codes snippet copied to clipboard!",
      icon: "success",
      });
    }
  }
</script>
<script defer src="https://umm.iris-home.net/script.js" data-website-id="935d19ad-65da-4632-9462-bcdc3e96befb"></script>
</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand navbar-brand-logo" href="http://localhost:4000/"><img alt="Yuanpeng's Blog Logo" src="/assets/img/home.png"/></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item">
              <a class="nav-link" href="/search">üîçSearch</a></li>
          <li class="nav-item">
              <a class="nav-link" href="/about">About</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Posts</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="/all_posts">All posts</a>
                    <a class="dropdown-item" href="/archive">Archive</a>
                    <a class="dropdown-item" href="/tags">Tags</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Academic</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="/nav_pages/publications">Publications</a>
                    <a class="dropdown-item" href="/nav_pages/lnotes">Learning Notes</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">More Links</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown"><a target="_blank" class="dropdown-item" href="https://me.iris-home.net">My Website</a>
								  <a target="_blank" class="dropdown-item" href="https://fla.iris-home.net">My Forum</a>
								  <a target="_blank" class="dropdown-item" href="https://www.ornl.gov/staff-profile/yuanpeng-zhang">ORNL Profile</a>
								  <a target="_blank" class="dropdown-item" href="https://scholar.google.com/citations?user=NgqIgO0AAAAJ&hl=en">Google Scholar</a>
								  <a target="_blank" class="dropdown-item" href="https://orcid.org/0000-0003-4224-3361">ORCID</a>
								  <a target="_blank" class="dropdown-item" href="https://rmcprofile.pages.ornl.gov/">RMCProfile</a>
								  <a target="_blank" class="dropdown-item" href="https://github.com/Kvieta1990">GitHub Profile</a>
								  <a target="_blank" class="dropdown-item" href="https://mybinder.org/v2/gh/Kvieta1990/Jup_Notes/master">Jupyter Binder</a>
								  <a target="_blank" class="dropdown-item" href="https://github.com/Kvieta1990/Iris">More Notes</a>
								  <a target="_blank" class="dropdown-item" href="https://github.com/Kvieta1990/Kvieta1990.github.io">Blog Repo</a>
								  <a target="_blank" class="dropdown-item" href="https://dify.iris-home.net/chat/bO3b1I3j159QHWTt">Dify Chat</a>
								  <a target="_blank" class="dropdown-item" href="https://gm.iris-home.net">Gemini Chat</a>
								  
            </div>
          </li>
        
          <li class="nav-item">
              <a class="nav-link" href="/contact">Contact</a></li></ul>
  </div>

  

  
    <div class="avatar-container">
      <div class="avatar-img-border" id="others">
      </div>
    </div>
    <div class="avatar-container">
      <div class="avatar-img-border">
					<div class="avatar-adjust" id="safari">
				  </div>
      </div>
    </div>
  

<script>
function myFunction() {
		return '<a href="http://localhost:4000/"><img alt="Navigation bar avatar" class="avatar-img" src="/assets/img/avatar-icon.png" />';
}
let safariAgent = navigator.userAgent.indexOf("Safari") > -1;
let chromeAgent = navigator.userAgent.indexOf("Chrome") > -1;
if (chromeAgent) {
  document.getElementById("others").innerHTML = myFunction();
} else if (safariAgent) {
  document.getElementById("safari").innerHTML = myFunction();
} else {
  document.getElementById("others").innerHTML = myFunction();
}

</script>

</nav>


  <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">
<script defer src="https://umm.iris-home.net/script.js" data-website-id="935d19ad-65da-4632-9462-bcdc3e96befb"></script>

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-10 offset-xl-1 col-lg-12 offset-lg-1">
        <div class="post-heading">
						<h1>RMCProfile + LAMMPS Implementation</h1>
          

          
					<span class="post-meta">Posted on June 11, 2023, by Yuanpeng Zhang</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-10 offset-xl-1 col-lg-12 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <p align="center">
<img src="/assets/img/posts/rmc_lammps.png" style="border:none;" width="600" alt="rmc_lammps" title="rmc_lammps" />
</p>

<p><br /></p>

<p>This blog is a collection of notes about implementing the <code class="language-plaintext highlighter-rouge">lammps</code> engine in our RMCProfile package [1] for energy
calculation, using the provided wrapper routines provided with the <code class="language-plaintext highlighter-rouge">lammps</code> distribution. The note will be covering
the installation of MPI compilers, building the <code class="language-plaintext highlighter-rouge">lammps</code> wrapper libraries, the implementation in the caller
program, shipping of the main caller program with the shared dynamic libraries, proper execution of the main caller
program, and the hybrid OMP &amp; MPI implementation.</p>

<h1 id="compiler-setup">Compiler Setup</h1>

<p>To build and run MPI program, we have to install a specific MPI
implementation, and <code class="language-plaintext highlighter-rouge">Open MPI</code> is the one that is often used. We can download the
latest version of Open MPI from here,</p>

<p><a href="https://www.open-mpi.org/">https://www.open-mpi.org/</a></p>

<p>Compiling Open MPI is straightforward and instruction can be found here,</p>

<p><a href="https://www.open-mpi.org/faq/?category=building">https://www.open-mpi.org/faq/?category=building</a></p>

<blockquote>
  <p>N.B. The compiler used for compiling Open MPI should be consistent with that
used for compiling our program that will use the MPI libraries. For example, in our
Fortran program, we are going to import the MPI library by using <code class="language-plaintext highlighter-rouge">USE MPI</code>.
Therefore, we have to specify the compiler we want to use for compiling Open MPI.
Here follows is the example case where we were using
<code class="language-plaintext highlighter-rouge">openmpi-4.1.4</code>. After unzipping the package to obtain the <code class="language-plaintext highlighter-rouge">openmpi-4.1.4</code>
directory, we can cd into it and execute <code class="language-plaintext highlighter-rouge">./configure --help</code> to list out all
the available flags among which we can find how to set a specific compiler for
certain languages, e.g., <code class="language-plaintext highlighter-rouge">FC</code> for fortran.</p>
</blockquote>

<blockquote>
  <p>Concerning the specification of fortran compiler, initially <code class="language-plaintext highlighter-rouge">FC=ifort</code> was
used, which however turned to be not working for some reason. Then it seems that
we have to give the full path to <code class="language-plaintext highlighter-rouge">ifort</code> compiler to make it work.</p>
</blockquote>

<blockquote>
  <p>At the end of the day, the following commands were executed in sequence to
compile <code class="language-plaintext highlighter-rouge">openmpi-4.1.4</code>,</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar </span>xzvf openmpi-4.1.4.tar.gz
<span class="nb">cd </span>openmpi-4.1.4
<span class="nb">mkdir </span>build
<span class="nb">cd </span>build
../configure <span class="nv">FC</span><span class="o">=</span>/opt/intel/bin/ifort <span class="nt">--prefix</span><span class="o">=</span>/opt/bin/
<span class="nb">sudo </span>make all <span class="nb">install</span>
</code></pre></div></div>

<p><br /></p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">--prefix=/opt/bin/</code> is telling the compiler where to install the compiled
executable.</p>
</blockquote>

<blockquote>
  <p>Alternatively, we can also follow the instruction here below to compile
Open MPI,</p>
</blockquote>

<p><a href="https://www.ibm.com/support/pages/how-do-i-recompile-and-install-openmpi-12-intel-compiler">https://www.ibm.com/support/pages/how-do-i-recompile-and-install-openmpi-12-intel-compiler</a></p>

<h1 id="demo-program-for-lammps-interface-with-fortran">Demo program for LAMMPS interface with Fortran</h1>

<ol>
  <li>
    <p>Untar the tarball downloaded containing the source codes of LAMMPS and then
go into the obtained directory, e.g., <code class="language-plaintext highlighter-rouge">lammps-stable_29Sep2021_update2</code>.</p>

    <blockquote>
      <p>Here is the source of lammps for this release, <a href="https://github.com/lammps/lammps/releases/tag/stable_29Sep2021_update2">https://github.com/lammps/lammps/releases/tag/stable_29Sep2021_update2</a></p>
    </blockquote>
  </li>
  <li>
    <p>Build LAMMPS shared library,</p>

    <blockquote>
      <p>Current note is a clean summary for steps we need to go through for
 building lammps. For detailed instruction, refer to the link below,</p>
    </blockquote>

    <blockquote>
      <p><a href="https://docs.lammps.org/Build_cmake.html#getting-started">https://docs.lammps.org/Build_cmake.html#getting-started</a></p>
    </blockquote>

    <blockquote>
      <p>Location of the built shared library needs to be specified when building
 the final caller program.</p>
    </blockquote>

    <blockquote>
      <p>Also, the shared library needs to be shipped together with the main caller
 program and meanwhile, the location of the shipped shared library needs to
 be exported before running the main caller program (using command
 like <code class="language-plaintext highlighter-rouge">export LD_LIBRARY_PATH=[wherever_the_shared_lib_is_located]</code>)</p>
    </blockquote>

    <p>2.1. <code class="language-plaintext highlighter-rouge">mkdir build &amp;&amp; cd build</code></p>

    <p>2.2. <code class="language-plaintext highlighter-rouge">cmake ../cmake -D BUILD_SHARED_LIBS=yes -DCMAKE_CXX_COMPILER=/opt/bin/mpicxx</code></p>

    <blockquote>
      <p>Refer to <a href="https://docs.lammps.org/Build_basics.html#build-the-lammps-executable-and-library">the link</a>
 for more information about building lammps library</p>
    </blockquote>

    <blockquote>
      <p>The <code class="language-plaintext highlighter-rouge">-DCMAKE_CXX_COMPILER</code> flag is for specifying the C++ compiler to use for
 compiling lammps. If not specifying the compiler explicitly, <code class="language-plaintext highlighter-rouge">cmake</code> will be able
 to find a usable C++ compiler on the building machine. However, in our case for
 building the lammps wrapper (see section-3.1 below), we specified the C++ compiler
 as <code class="language-plaintext highlighter-rouge">/opt/bin/mpicxx</code>. Therefore, it should be better to keep consistence in terms
 of the C++ compiler being used in multiple spots. Though, I am not sure whether
 using different version of the C++ compilers will work. But at least, using the same
 version of the C++ compiler turned out to be working without problems.</p>
    </blockquote>

    <p>2.3. <code class="language-plaintext highlighter-rouge">make -j 24</code></p>

    <blockquote>
      <p><code class="language-plaintext highlighter-rouge">24</code> here means we want to use 24 cores for building lammps in parallel to
 speed up the compilation.</p>
    </blockquote>

    <p>2.4. Taking the main directory <code class="language-plaintext highlighter-rouge">lammps-stable_29Sep2021_update2</code> as the
 example, we should be able to find <code class="language-plaintext highlighter-rouge">liblammps.so.0</code> (together with a soft
 symbol <code class="language-plaintext highlighter-rouge">liblammps.so</code> linked to <code class="language-plaintext highlighter-rouge">liblammps.so.0</code>, in the same directory with
 <code class="language-plaintext highlighter-rouge">liblammps.so.0</code>) in the following directory,</p>

    <p><code class="language-plaintext highlighter-rouge">/[whatever_location]/lammps-stable_29Sep2021_update2/build</code></p>
  </li>
  <li>
    <p>Build the main caller program</p>

    <blockquote>
      <p>Here, we will take the <code class="language-plaintext highlighter-rouge">fortran2</code> example included in the shipped
 source codes of lammps. Again, taking the <a href="https://github.com/lammps/lammps/releases/tag/stable_29Sep2021_update2">stable_29Sep2021_update2</a>
 as the example, the <code class="language-plaintext highlighter-rouge">fortran2</code> directory can be found here,</p>
    </blockquote>

    <blockquote>
      <p><code class="language-plaintext highlighter-rouge">/[whatever_location]/lammps-stable_29Sep2021_update2/examples/COUPLE/fortran2</code></p>
    </blockquote>

    <blockquote>
      <p>N.B. for the following instructions, we will assume that we are located in
 this directory,</p>
    </blockquote>

    <p><code class="language-plaintext highlighter-rouge">/home/y8z/BBird_Ext/Packages/lammps-stable_29Sep2021_update2/examples/COUPLE/fortran2</code></p>

    <blockquote>
      <p>Codes in this directory has been modified to build a minimal example to be
 used as the template for further development.</p>
    </blockquote>

    <p>3.1. <code class="language-plaintext highlighter-rouge">make</code></p>

    <blockquote>
      <p>The <code class="language-plaintext highlighter-rouge">Makefile</code> is provided with lammps distribution, which basically
 packages up those steps as specified in the <code class="language-plaintext highlighter-rouge">README</code> file.</p>
    </blockquote>

    <blockquote>
      <p>In our case for compiling the lammps wrapper for RMCProfile package, the <code class="language-plaintext highlighter-rouge">Makefile</code> being
 used can be found here,</p>
    </blockquote>

    <blockquote>
      <p><a href="https://code.ornl.gov/mth/RMCProfile/-/blob/lammps_rmc_ready/ubuntu1804-cuda-intel/Makefile_lammps_wrapper">https://code.ornl.gov/mth/RMCProfile/-/blob/lammps_rmc_ready/ubuntu1804-cuda-intel/Makefile_lammps_wrapper</a></p>
    </blockquote>

    <blockquote>
      <p>In the Makefile, the C++ compiler was specified as <code class="language-plaintext highlighter-rouge">/opt/bin/mpicxx</code>, as can be found here,</p>
    </blockquote>

    <blockquote>
      <p><a href="https://code.ornl.gov/mth/RMCProfile/-/blob/lammps_rmc_ready/ubuntu1804-cuda-intel/Makefile_lammps_wrapper#L11">https://code.ornl.gov/mth/RMCProfile/-/blob/lammps_rmc_ready/ubuntu1804-cuda-intel/Makefile_lammps_wrapper#L11</a></p>
    </blockquote>

    <p>3.2. <code class="language-plaintext highlighter-rouge">/opt/bin/mpifort -c simple.f90</code></p>

    <p>3.3. <code class="language-plaintext highlighter-rouge">/opt/bin/mpifort -c serial.f90</code></p>

    <p>3.4. <code class="language-plaintext highlighter-rouge">/opt/bin/mpifort -c main.f90</code></p>

    <p>3.3. <code class="language-plaintext highlighter-rouge">/opt/bin/mpifort main.o serial.o LAMMPS.o LAMMPS-wrapper.o simple.o -L /home/y8z/BBird_Ext/Temp_Ext/lammps-stable_29Sep2021_update2/build -L . -llammps -llammps_fortran -lmpi_cxx -lstdc++ -lm -o main</code></p>

    <blockquote>
      <p><code class="language-plaintext highlighter-rouge">main</code> is the finally compiled executable.</p>
    </blockquote>

    <blockquote>
      <p>The prefix <code class="language-plaintext highlighter-rouge">/opt/bin/</code> may be removed if <code class="language-plaintext highlighter-rouge">mpifort</code> is in our system path.
 However, in my case, for the reason given down below (see step 4), adding
 the path to our environment path variable won‚Äôt work. The workaround may be
 to create alias to <code class="language-plaintext highlighter-rouge">/opt/bin/mpifort</code> and all the other commands.</p>
    </blockquote>

    <blockquote>
      <p>In <a href="https://docs.lammps.org/Build_basics.html#build-the-lammps-executable-and-library">this link</a>,
 we can see that the <code class="language-plaintext highlighter-rouge">LAMMPS_MACHINE</code> flag can be specified. If we do that
 and assume we give it the name of <code class="language-plaintext highlighter-rouge">myname</code>, the file name of the compiled
 shared library will also be changed accordingly, from the default
 <code class="language-plaintext highlighter-rouge">liblammps.so.0</code> to <code class="language-plaintext highlighter-rouge">liblammps_myname.so.0</code> (same thing will happen to the
 soft link as well). In this case, the library link flag in the final
 compile command should be changed from <code class="language-plaintext highlighter-rouge">-llammps</code> to <code class="language-plaintext highlighter-rouge">-llammps_myname</code>.</p>
    </blockquote>

    <blockquote>
      <p>Same comments as above applies to the <code class="language-plaintext highlighter-rouge">-llammps_fortran</code> as well - in the
 included <code class="language-plaintext highlighter-rouge">Makefile</code>, the compiled shared library is by default given the
 name of <code class="language-plaintext highlighter-rouge">liblammps_fortran.so</code>. If we change its name in <code class="language-plaintext highlighter-rouge">Makefile</code>, we need
 to change the flag accordingly.</p>
    </blockquote>

    <blockquote>
      <p>For the flag <code class="language-plaintext highlighter-rouge">-llammps</code>, there is a pitfall to notice - the actual shared
 library name is <code class="language-plaintext highlighter-rouge">liblammps.so.0</code> (taking its default name as the example)
 and we have <code class="language-plaintext highlighter-rouge">liblammps.so</code> as a soft link to <code class="language-plaintext highlighter-rouge">liblammps.so.0</code>. When
 compiling the final executable (here, <code class="language-plaintext highlighter-rouge">simpleF</code>), the compiling command is
 actually expecting <code class="language-plaintext highlighter-rouge">liblammps.so</code>. However, when executing the final
 executable (see step below for an example of execution), it is instead
 expecting <code class="language-plaintext highlighter-rouge">liblammps.so.0</code>, simple because the <code class="language-plaintext highlighter-rouge">liblammps.so.0</code> is the file
 containing the actual contents of the library and <code class="language-plaintext highlighter-rouge">liblammps.so</code> is just a
 soft link to the library file.</p>
    </blockquote>
  </li>
  <li>
    <p>Execute the main executable as,</p>

    <p><code class="language-plaintext highlighter-rouge">/opt/bin/mpirun -np 4 ./main</code></p>

    <blockquote>
      <p>According to the notes in the following link,</p>
    </blockquote>

    <blockquote>
      <p><a href="https://stackoverflow.com/questions/37110538/open-mpi-scalasca-can-not-run-mpirun-command-with-option-prefix">https://stackoverflow.com/questions/37110538/open-mpi-scalasca-can-not-run-mpirun-command-with-option-prefix</a></p>
    </blockquote>

    <blockquote>
      <p>prepending the full path to the <code class="language-plaintext highlighter-rouge">mpirun</code> executable is equivalent to add
 in the <code class="language-plaintext highlighter-rouge">--prefix</code> flag to specify the prefix option. It seems that this flag
 is to specify the library location and in principle we can export the path
 of the Open MPI libraries to the <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> variable ‚Äì following the example
 above, the command would be,</p>
    </blockquote>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">"/opt/lib:</span><span class="nv">$LD_LIBRARY_PATH</span><span class="s2">"</span>
</code></pre></div>    </div>

    <p><br /></p>

    <blockquote>
      <p>See the <code class="language-plaintext highlighter-rouge">Compiler Setup</code> section of the current note for the path specified
 to contain the compiled Open MPI libraries.</p>
    </blockquote>

    <blockquote>
      <p>However, given the current configuration on BigBird machine, it seems that
 the currently existing multiple versions of OpenMPI builds in the systems
 messed up the libraries, etc. So, for some reason, exporting the library
 path like above won‚Äôt work. In such a situation, we have to prepend the
 executable with the full path. A workaround may be to create alias to the
 full path of the command.</p>
    </blockquote>

    <blockquote>
      <p>Unfortunately, the approach of creating alias for the full path won‚Äôt work
 when submitting jobs via, e.g., slurm, i.e., it seems that for some reason the
 job submission routine won‚Äôt be able to find the right libraries to use even
 we have already created the alias for the full path of the <code class="language-plaintext highlighter-rouge">mpirun</code> command.
 In such cases, we have to use the full path of the <code class="language-plaintext highlighter-rouge">mpirun</code> executable in the
 job submission script.</p>
    </blockquote>
  </li>
  <li>
    <p>Here following is a list of those libraries that need to be shipped with
RMCProfile package to guarantee they can be found and called at run time.</p>

    <ul>
      <li>
        <p>libifcoremt.so.5</p>
      </li>
      <li>
        <p>libifport.so.5</p>
      </li>
      <li>
        <p>libimf.so</p>
      </li>
      <li>
        <p>libintlc.so.5</p>
      </li>
      <li>
        <p>liblammps.so.0</p>
      </li>
      <li>
        <p>liblammps.so -&gt; liblammps.so.0</p>
      </li>
      <li>
        <p>liblammps_fortran.so</p>
      </li>
      <li>
        <p>libmpi.so.40.30.4</p>
      </li>
      <li>
        <p>libmpi.so -&gt; libmpi.so.40.30.4</p>
      </li>
      <li>
        <p>libsvml.so</p>
      </li>
    </ul>

    <blockquote>
      <p>As a personal note, those libraries can be found in the following directory on
 our building machine BigBird,</p>
    </blockquote>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /home/y8z/BBird_Ext/Packages/lammps-stable_29Sep2021_update2/build
</code></pre></div>    </div>

    <p><br /></p>

    <blockquote>
      <p>On the public domain, those libraries can be found here,</p>
    </blockquote>

    <blockquote>
      <p><a href="https://code.ornl.gov/mth/RMCProfile/-/tree/lammps_rmc_ready/package/linux/MPI">https://code.ornl.gov/mth/RMCProfile/-/tree/lammps_rmc_ready/package/linux/MPI</a></p>
    </blockquote>
  </li>
  <li>
    <p>With the MPI program compiled following the way described in this doc, it
should be only executed via <code class="language-plaintext highlighter-rouge">/opt/bin/mpirun</code>, i.e., directly executing the
compiled executable just like a serial program should <em>NOT</em> work.</p>

    <blockquote>
      <p>In our case of compiling the RMCProfile package with lammps, we are linking the
 dynamic library <code class="language-plaintext highlighter-rouge">libmpi_cxx.so</code> (see the <code class="language-plaintext highlighter-rouge">-lmpi_cxx</code> flag in the link below),</p>
    </blockquote>

    <blockquote>
      <p><a href="https://code.ornl.gov/mth/RMCProfile/-/blob/lammps_rmc_ready/ubuntu1804-cuda-intel/Makefile_mpi#L21-24">https://code.ornl.gov/mth/RMCProfile/-/blob/lammps_rmc_ready/ubuntu1804-cuda-intel/Makefile_mpi#L21-24</a></p>
    </blockquote>

    <blockquote>
      <p>So, we include the <code class="language-plaintext highlighter-rouge">libmpi_cxx.so.40.20.1</code> library file together with its
 soft link in our shipped RMCProfile package as well, under the shared library
 directory which will be exported as the <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> environment variable
 while running RMCProfile. I am not sure whether this is necessary but it should
 be safe to include it anyways.</p>
    </blockquote>
  </li>
  <li>
    <p>About the hybrid MPI and OMP parallel implementation.</p>

    <blockquote>
      <p>It seems that the OMP session can be safely included in the MPI code without
 that much special attention to be paid, as long as we are not playing around
 with MPI communications within the OMP session.</p>
    </blockquote>

    <blockquote>
      <p>For compiling, when using intel compiler, the flag for OMP is <code class="language-plaintext highlighter-rouge">-qopenmp</code>
 whereas for GNU compiler, the flag is <code class="language-plaintext highlighter-rouge">-fopenmp</code>.</p>
    </blockquote>
  </li>
</ol>

<p><b>References</b></p>

<p>[1] <a href="https://rmcprofile.ornl.gov/">https://rmcprofile.ornl.gov/</a></p>

      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/tags#programming">programming</a>
          
            <a href="/tags#RMCProfile">RMCProfile</a>
          
            <a href="/tags#LAMMPS">LAMMPS</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a target="_blank" href="https://twitter.com/intent/tweet?text=RMCProfile+%2B+LAMMPS+Implementation&url=http%3A%2F%2Flocalhost%3A4000%2F2023-06-11-rmc_lammps%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2023-06-11-rmc_lammps%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2023-06-11-rmc_lammps%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

</section>



      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/2023-04-15-notes_jbook/" data-toggle="tooltip" data-placement="top" title="Notes on using Jupyter book">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/2023-08-11-rmc_papers/" data-toggle="tooltip" data-placement="top" title="Typical Science Papers with RMCProfile">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  <div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_shortname = &quot;rmcprofile&quot;;
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://rmcprofile.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row column_top">
        <div class="col-xl-10 offset-xl-1 col-lg-10 offset-lg-1">
        <h3>External Links</h3>
        </div>
    </div>
    <div class="row" style="margin-bottom:10px">
        <div class="col-xl-10 offset-xl-1 col-lg-10 offset-lg-1">
      <div class="column" style="background-color:#EAEAEA;">
        <h4>Monte Carlo</h4>
				<a target="_blank" href="https://tproffen.github.io/DiffuseCode/">DISCUS</a>
				</br>
				<a target="_blank" href="https://www.szfki.hu/~nphys/rmc++/opening.html">RMC++</a>
				</br>
				<a target="_blank" href="https://research.csiro.au/mmm/hrmc/">HRMC</a>
				</br>
				<a target="_blank" href="https://bachiraoun.github.io/fullrmc/">fullrmc</a>
				</br>
        <a target="_blank" href="http://www.dragon.lv/exafs/rmc.htm">RMC for EXAFS</a>
        </br>
        <a target="_blank" href="https://www.isis.stfc.ac.uk/Pages/Empirical-Potential-Structure-Refinement.aspx">EPSR</a>
				</br>
				<a target="_blank" href="http://wwwisis2.isis.rl.ac.uk/rmc/">RMC at ISIS facility</a>
				</br>
				<a target="_blank" href="https://rmcprofile.pages.ornl.gov/">RMCProfile website</a>
				</br>
				<a target="_blank" href="http://www.rmcprofile.org/Main_Page">RMCProfile website - legacy</a>
				</br>
				<a target="_blank" href="https://en.wikipedia.org/wiki/Reverse_Monte_Carlo">Wikipedia for RMC</a>
      </div>
      <div class="column" style="background-color:#EAEAEA;">
        <h4>Rietveld-like</h4>
        <a target="_blank" href="https://www.diffpy.org/products/pdfgui.html">PDFgui</a>
        </br>
        <a target="_blank" href="https://www.diffpy.org/products/diffpycmi/index.html">DIFFPy-CMI</a>
        </br>
        <a target="_blank" href="https://www.diffpy.org/products/mPDF.html">magnetic PDF</a>
        </br>
        <a target="_blank" href="https://community.dur.ac.uk/john.evans/topas_workshop/tutorial_pdf_sno2.htm">Topas for PDF</a>
      </div>
      <div class="column" style="background-color:#EAEAEA;">
        <h4>Tools</h4>
        <a target="_blank" href="http://addie.ornl.gov/">ADDIE</a>
        </br>
				<a target="_blank"
						href="http://li.mit.edu/Archive/Graphics/A/">Atomeye</a>
				</br>
				<a target="_blank"
						href="https://sourceforge.net/projects/xming/">Xming</a>
				</br>
				<a target="_blank"
						href="https://www.mantidproject.org/Main_Page">Mantid</a>
				</br>
				<a target="_blank" href="https://www.facebook.com/disord.matt">GUDRUN</a>
				</br>
				<a target="_blank"
						href="https://www.diffpy.org/products/pdfgetx.html">PDFGet..
						</a>
				</br>
				<a target="_blank" href="https://www.ncnr.nist.gov/resources/n-lengths/">Neutron scattering length</a>
				</br>
				<a target="_blank" href="http://wwwisis2.isis.rl.ac.uk/reference/Xray_scatfac.htm">X-ray form factor</a>
				</br>
				<a target="_blank" href="https://www.webelements.com/">Web elements</a>
				</br>
				<a target="_blank" href="https://ptable.com/#Properties">Dynamic
						periodic table</a>
				</br>
				<a target="_blank" href="http://wwwisis2.isis.rl.ac.uk/disordered/Manuals/ATLAS/atlas_values.htm">ISIS values</a>
				</br>
      </div>
      <div class="column" style="background-color:#EAEAEA;">
        <h4>Facilities</h4>
				<a target="_blank" href="https://neutrons.ornl.gov/nomad">US - ORNL - NOMAD</a>
        </br>
				<a target="_blank" href="https://neutrons.ornl.gov/powgen">US - ORNL -
						POWGEN</a>
				</br>
				<a target="_blank" href="https://www.aps.anl.gov/Beamlines/Directory/Details?beamline_id=16">US - APS - 11-ID-B</a>
				</br>
				<a target="_blank" href="https://www.bnl.gov/ps/beamlines/beamline.php?r=28-ID-1">US - BNL - 28-ID-1</a>
				</br>
				<a target="_blank"
						href="https://www.isis.stfc.ac.uk/Pages/Gem.aspx">UK - ISIS - GEM</a>
				</br>
				<a target="_blank" href="https://www.isis.stfc.ac.uk/Pages/polaris.aspx">UK - ISIS - Polaris</a>
				</br>
				<a target="_blank" href="https://www.diamond.ac.uk/Instruments/Crystallography/I15-1.html">UK - Diamond - I15-1</a>
				</br>
				<a target="_blank" href=""https://mlfinfo.jp/en/bl21/>Japan - J-PARC - NOVA</a>
				</br>
				<a target="_blank" href="http://www.spring8.or.jp/wkg/BL14B1/instrument/lang-en/INS-0000000309/instrument_summary_view">Japan - SPRING8 - BL14B1</a>
				</br>
				<a target="_blank" href="http://www.spring8.or.jp/wkg/BL22XU/instrument/lang-en/INS-0000000327/instrument_summary_view">Japan - SPRING8 - BL22XU</a>
				</br>
				<a target="_blank" href="https://europeanspallationsource.se/instruments/heimdal">Europe - ESS - HEIMDAL</a>
				</br>
				<a target="_blank" href="http://e-ssrf.sinap.cas.cn/beamlines/bl13w1/201401/t20140112_152430.html">China - SSRF - BL13W1</a>
      </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 footer_bottom">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a target="_blank" href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a target="_blank" href="mailto:zhangy3@ornl.gov" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a target="_blank" href="https://github.com/kvieta1990" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">

      
      </p>
      <p class="theme-by text-muted">
        Copyright 2020 ¬©
        <a>Yuanpeng Zhang</a>
      </p>
      </div>
    </div>
	<div class="row" id="vistor_map" style="position:absolute; left:-10px; bottom:20px;">
	  <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=000000&w=300&t=tt&d=mXrA2cjTFPms32CLvpbXJeN7mGr8Pp6J7WRX3Im-ZOw&co=eaeaea&ct=000000'></script>
	</div>
  </div>
</footer>


  
  
    
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  









</body>
</html>
